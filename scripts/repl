#!/bin/sh

# Load environment variables from .env file if it exists
if [ -f ./config/.env ]; then
  export $(cat ./config/.env | grep -v "^#" | xargs)
fi

# Set current directory to the script's directory
cd "$(dirname "$0")/.." || exit

# Generate completions file if it doesn't exist
if [ ! -f "./scripts/completions/arca_completions" ]; then
  echo "Generating completions file..."
  # Use mix run instead of direct script execution
  mix run scripts/completions/generate.ex
fi

# Check if rlwrap is available
if command -v rlwrap > /dev/null; then
  RLWRAP_CMD="rlwrap"
  
  # Set up completions if the file exists
  if [ -f "./scripts/completions/arca_completions" ]; then
    RLWRAP_OPTS="-f ./scripts/completions/arca_completions --complete-filenames"
  else
    RLWRAP_OPTS=""
  fi
else
  RLWRAP_CMD=""
  RLWRAP_OPTS=""
  echo "Warning: rlwrap not found. Install rlwrap for command history and completion."
fi

# Define the original command
ORIGINAL_COMMAND="ARCA_CONFIG_PATH=.arca ARCA_CONFIG_FILE=config.json mix Arca.CLI repl $*"

# Run the command with rlwrap if available
if [ -n "$RLWRAP_CMD" ]; then
  $RLWRAP_CMD $RLWRAP_OPTS $SHELL -c "$ORIGINAL_COMMAND"
else
  $SHELL -c "$ORIGINAL_COMMAND"
fi
